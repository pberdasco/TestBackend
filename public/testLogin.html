<!DOCTYPE html>
<html>
  <body>
    <h2>Probar login</h2>
    <form id="loginForm">
      <input type="email" name="mail" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>

    <button id="btnMe" disabled>Obtener roles y derechos</button>
    <button id="btnRefresh" disabled>Renovar token</button>
    <button id="btnLogout" disabled>Logout</button>
    <pre id="me"></pre>

    <script>
      const form = document.getElementById("loginForm");
      const btnMe = document.getElementById("btnMe");
      const btnRefresh = document.getElementById("btnRefresh");
      const btnLogout = document.getElementById("btnLogout");
      const pre = document.getElementById("me");

      function setSesionActiva(activa) {
        btnMe.disabled = !activa;
        btnRefresh.disabled = !activa;
        btnLogout.disabled = !activa;
        if (!activa) {
          pre.textContent = "Sesión cerrada.";
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const data = {
          mail: form.mail.value,
          password: form.password.value,
        };

        const loginRes = await fetch("http://localhost:5050/api/usuarios/login", {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(data),
        });

        if (loginRes.ok) {
          setSesionActiva(true);
          pre.textContent = "Login exitoso. Ahora podés obtener roles y derechos.";
        } else {
          setSesionActiva(false);
          const err = await loginRes.json();
          pre.textContent = "Login falló: " + (err?.message || loginRes.status);
        }
      });

      btnMe.addEventListener("click", async () => {
        const res = await fetch("http://localhost:5050/api/usuarios/me", {
          credentials: "include",
        });

        if (res.ok) {
          const json = await res.json();
          pre.textContent = "/me = \n" + JSON.stringify(json, null, 2);
        } else {
          const err = await res.json();
          pre.textContent = "Error al obtener /me: " + (err?.message || res.status);
        }
      });

      btnRefresh.addEventListener("click", async () => {
        const res = await fetch("http://localhost:5050/api/usuarios/refresh", {
          method: "POST",
          credentials: "include",
        });

        if (res.ok) {
          pre.textContent = "Token renovado correctamente.";
        } else {
          const err = await res.json();
          setSesionActiva(false);
          pre.textContent = "Error al renovar token: " + (err?.message || res.status);
        }
      });

      btnLogout.addEventListener("click", async () => {
        const res = await fetch("http://localhost:5050/api/usuarios/logout", {
          method: "POST",
          credentials: "include",
        });

        if (res.ok) {
          setSesionActiva(false);
          pre.textContent = "Sesión cerrada exitosamente.";
        } else {
          const err = await res.json();
          pre.textContent = "Error al cerrar sesión: " + (err?.message || res.status);
        }
      });
    </script>
  </body>
</html>


